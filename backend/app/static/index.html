<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Refinery Dashboard</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0f1923;--bg2:#1a2736;--bg3:#243447;--bg4:#2e4058;
  --border:#2e4058;--border2:#3a5068;
  --text:#e0e6ed;--text2:#8899aa;--text3:#556677;
  --green:#22c55e;--green-bg:rgba(34,197,94,.12);
  --yellow:#eab308;--yellow-bg:rgba(234,179,8,.12);
  --red:#ef4444;--red-bg:rgba(239,68,68,.12);
  --blue:#3b82f6;--blue-bg:rgba(59,130,246,.12);
  --cyan:#06b6d4;
  --accent:#6366f1;--accent-bg:rgba(99,102,241,.12);
  --mono:'Consolas','Monaco','Courier New',monospace;
  --sans:system-ui,-apple-system,'Segoe UI',Roboto,sans-serif;
  --radius:8px;--radius-sm:4px;
}
html{font-size:14px}
body{font-family:var(--sans);background:var(--bg);color:var(--text);min-height:100vh;line-height:1.5}
a{color:var(--cyan);text-decoration:none}
a:hover{text-decoration:underline}

/* Header */
.header{background:var(--bg2);border-bottom:1px solid var(--border);padding:0 24px;display:flex;align-items:center;height:56px;gap:24px;position:sticky;top:0;z-index:100}
.header h1{font-size:1.15rem;font-weight:600;white-space:nowrap;color:var(--text)}
.header h1 span{color:var(--accent);font-weight:700}
.health-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-left:8px;vertical-align:middle}
.health-dot.ok{background:var(--green);box-shadow:0 0 6px var(--green)}
.health-dot.err{background:var(--red);box-shadow:0 0 6px var(--red)}
.health-dot.unknown{background:var(--text3)}

/* Tabs */
.tabs{display:flex;gap:2px;margin-left:auto}
.tab-btn{background:none;border:none;color:var(--text2);padding:8px 18px;cursor:pointer;font-size:.9rem;font-family:var(--sans);border-radius:var(--radius-sm) var(--radius-sm) 0 0;transition:all .15s}
.tab-btn:hover{color:var(--text);background:var(--bg3)}
.tab-btn.active{color:var(--text);background:var(--bg);font-weight:600}

/* Main */
.main{padding:24px;max-width:1400px;margin:0 auto}
.tab-content{display:none}
.tab-content.active{display:block}

/* Cards */
.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin-bottom:24px}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:18px;transition:border-color .15s}
.card:hover{border-color:var(--border2)}
.card-label{font-size:.78rem;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.card-value{font-size:1.8rem;font-weight:700;font-family:var(--mono)}
.card-sub{font-size:.78rem;color:var(--text3);margin-top:4px}
.card.green .card-value{color:var(--green)}
.card.yellow .card-value{color:var(--yellow)}
.card.red .card-value{color:var(--red)}
.card.blue .card-value{color:var(--blue)}
.card.accent .card-value{color:var(--accent)}

/* Stage cards */
.stage-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-bottom:24px}
.stage-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:14px;text-align:center}
.stage-card .stage-name{font-size:.78rem;color:var(--text2);text-transform:uppercase;letter-spacing:.4px;margin-bottom:4px}
.stage-card .stage-count{font-size:1.4rem;font-weight:700;font-family:var(--mono)}

/* Tables */
.toolbar{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
.toolbar input,.toolbar select{background:var(--bg2);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:var(--radius-sm);font-size:.85rem;font-family:var(--sans)}
.toolbar input{min-width:220px}
.toolbar input:focus,.toolbar select:focus{outline:none;border-color:var(--accent)}
.toolbar select{cursor:pointer}

.table-wrap{overflow-x:auto;border:1px solid var(--border);border-radius:var(--radius);background:var(--bg2)}
table{width:100%;border-collapse:collapse;font-size:.85rem}
th{background:var(--bg3);text-align:left;padding:10px 14px;font-weight:600;color:var(--text2);text-transform:uppercase;font-size:.75rem;letter-spacing:.4px;white-space:nowrap;position:sticky;top:0}
td{padding:10px 14px;border-top:1px solid var(--border);vertical-align:top}
tr{transition:background .1s}
tbody tr:hover{background:var(--bg3);cursor:pointer}
.code-cell{font-family:var(--mono);font-weight:600;color:var(--cyan)}
.badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:.75rem;font-weight:600}
.badge-green{background:var(--green-bg);color:var(--green)}
.badge-yellow{background:var(--yellow-bg);color:var(--yellow)}
.badge-red{background:var(--red-bg);color:var(--red)}
.badge-blue{background:var(--blue-bg);color:var(--blue)}
.badge-accent{background:var(--accent-bg);color:var(--accent)}

/* Pagination */
.pagination{display:flex;align-items:center;gap:12px;margin-top:16px;justify-content:center}
.pagination button{background:var(--bg2);border:1px solid var(--border);color:var(--text);padding:6px 14px;border-radius:var(--radius-sm);cursor:pointer;font-size:.85rem;font-family:var(--sans)}
.pagination button:hover:not(:disabled){background:var(--bg3);border-color:var(--border2)}
.pagination button:disabled{opacity:.4;cursor:not-allowed}
.pagination span{color:var(--text2);font-size:.85rem}

/* Slide-out panel */
.panel-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;opacity:0;pointer-events:none;transition:opacity .2s}
.panel-overlay.open{opacity:1;pointer-events:auto}
.panel{position:fixed;top:0;right:0;bottom:0;width:560px;max-width:90vw;background:var(--bg);border-left:1px solid var(--border);z-index:201;transform:translateX(100%);transition:transform .25s ease;overflow-y:auto;padding:24px}
.panel.open{transform:translateX(0)}
.panel-close{position:absolute;top:16px;right:16px;background:none;border:none;color:var(--text2);font-size:1.4rem;cursor:pointer;line-height:1}
.panel-close:hover{color:var(--text)}
.panel h2{font-size:1.2rem;margin-bottom:4px}
.panel h3{font-size:.95rem;color:var(--text2);margin:20px 0 10px;text-transform:uppercase;letter-spacing:.4px}
.panel-code{font-family:var(--mono);font-size:1.6rem;font-weight:700;color:var(--cyan)}
.panel-desc{color:var(--text2);margin:8px 0 16px}

.detail-list{list-style:none;padding:0}
.detail-list li{padding:10px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;gap:12px}
.detail-list li:last-child{border-bottom:none}
.detail-label{color:var(--text2);font-size:.82rem}
.detail-value{font-weight:600;text-align:right}

.cause-item,.step-item{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;margin-bottom:8px}
.cause-item .cause-name{font-weight:600;margin-bottom:4px}
.cause-item .cause-likelihood{font-size:.82rem;color:var(--yellow)}
.step-item .step-num{font-family:var(--mono);color:var(--accent);font-weight:700;margin-right:8px}
.step-item .step-desc{color:var(--text)}

.sensor-tag{display:inline-block;background:var(--bg3);border:1px solid var(--border);padding:2px 8px;border-radius:10px;font-size:.78rem;font-family:var(--mono);margin:2px}
.tsb-ref{font-family:var(--mono);color:var(--yellow);font-size:.85rem}

/* Timeline */
.timeline{position:relative;padding-left:20px;margin:12px 0}
.timeline::before{content:'';position:absolute;left:6px;top:0;bottom:0;width:2px;background:var(--border)}
.timeline-item{position:relative;padding:8px 0 8px 16px;font-size:.85rem}
.timeline-item::before{content:'';position:absolute;left:-17px;top:14px;width:10px;height:10px;border-radius:50%;background:var(--bg3);border:2px solid var(--border)}
.timeline-item.done::before{background:var(--green);border-color:var(--green)}
.timeline-item.active::before{background:var(--yellow);border-color:var(--yellow)}
.timeline-item.error::before{background:var(--red);border-color:var(--red)}
.timeline-item .tl-stage{font-weight:600}
.timeline-item .tl-time{color:var(--text3);font-size:.78rem;margin-left:8px}

/* Bars */
.bar-chart{margin:16px 0}
.bar-row{display:flex;align-items:center;margin-bottom:10px;gap:12px}
.bar-label{min-width:120px;font-size:.82rem;color:var(--text2);text-align:right}
.bar-track{flex:1;height:24px;background:var(--bg2);border-radius:var(--radius-sm);overflow:hidden;border:1px solid var(--border)}
.bar-fill{height:100%;border-radius:var(--radius-sm);transition:width .4s ease;display:flex;align-items:center;justify-content:flex-end;padding-right:8px;font-size:.75rem;font-weight:600;min-width:fit-content}
.bar-fill.green{background:linear-gradient(90deg,rgba(34,197,94,.3),rgba(34,197,94,.6));color:var(--green)}
.bar-fill.blue{background:linear-gradient(90deg,rgba(59,130,246,.3),rgba(59,130,246,.6));color:var(--blue)}
.bar-fill.yellow{background:linear-gradient(90deg,rgba(234,179,8,.3),rgba(234,179,8,.6));color:var(--yellow)}
.bar-fill.accent{background:linear-gradient(90deg,rgba(99,102,241,.3),rgba(99,102,241,.6));color:var(--accent)}

/* Section headings */
.section-title{font-size:1rem;font-weight:600;margin-bottom:16px;color:var(--text);display:flex;align-items:center;gap:8px}
.section-title::after{content:'';flex:1;height:1px;background:var(--border)}

/* Pipeline info blocks */
.info-block{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:16px}
.info-block h4{font-size:.85rem;color:var(--text2);text-transform:uppercase;letter-spacing:.4px;margin-bottom:12px}
.info-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:.85rem}
.info-row:last-child{border-bottom:none}
.info-key{color:var(--text2)}
.info-val{font-weight:600;font-family:var(--mono)}

/* Plans */
.plan-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px}
.plan-card h4{font-weight:600;margin-bottom:6px}
.plan-card .plan-meta{font-size:.78rem;color:var(--text3);margin-bottom:8px}
.plan-card .plan-queries{list-style:none;padding:0}
.plan-card .plan-queries li{padding:4px 0;font-size:.85rem;color:var(--text2)}
.plan-card .plan-queries li::before{content:'\2022';color:var(--accent);margin-right:8px}

/* Empty / loading states */
.empty-state{text-align:center;padding:48px 24px;color:var(--text3)}
.loading{text-align:center;padding:32px;color:var(--text3)}
.error-msg{background:var(--red-bg);color:var(--red);padding:12px 16px;border-radius:var(--radius-sm);margin:8px 0;font-size:.85rem}

/* Refresh indicator */
.refresh-indicator{font-size:.75rem;color:var(--text3);margin-left:auto;white-space:nowrap}
</style>
</head>
<body>

<div class="header">
  <h1><span>Refinery</span> Dashboard</h1>
  <span id="healthDot" class="health-dot unknown" title="Checking health..."></span>
  <nav class="tabs">
    <button class="tab-btn active" data-tab="overview">Overview</button>
    <button class="tab-btn" data-tab="dtc">DTC Codes</button>
    <button class="tab-btn" data-tab="documents">Documents</button>
    <button class="tab-btn" data-tab="pipeline">Pipeline</button>
  </nav>
</div>

<div class="main">
  <!-- OVERVIEW TAB -->
  <div id="tab-overview" class="tab-content active">
    <div class="section-title">Pipeline Stats <span id="overviewRefresh" class="refresh-indicator"></span></div>
    <div id="statsCards" class="cards"><div class="loading">Loading stats...</div></div>
    <div class="section-title">Documents by Stage</div>
    <div id="stageGrid" class="stage-grid"><div class="loading">Loading...</div></div>
    <div class="section-title">Knowledge Counts</div>
    <div id="knowledgeCards" class="cards"><div class="loading">Loading...</div></div>
    <div class="section-title">Queue Depths</div>
    <div id="overviewQueues" class="bar-chart"><div class="loading">Loading...</div></div>
  </div>

  <!-- DTC CODES TAB -->
  <div id="tab-dtc" class="tab-content">
    <div class="section-title">DTC Codes</div>
    <div class="toolbar">
      <input type="text" id="dtcSearch" placeholder="Search by code (e.g. P0301)...">
      <select id="dtcCategoryFilter"><option value="">All Categories</option></select>
    </div>
    <div id="dtcTable" class="table-wrap"><div class="loading">Loading DTC codes...</div></div>
    <div id="dtcPagination" class="pagination"></div>
  </div>

  <!-- DOCUMENTS TAB -->
  <div id="tab-documents" class="tab-content">
    <div class="section-title">Documents</div>
    <div class="toolbar">
      <select id="docStageFilter">
        <option value="">All Stages</option>
        <option value="ingested">Ingested</option>
        <option value="chunked">Chunked</option>
        <option value="extracting">Extracting</option>
        <option value="evaluating">Evaluating</option>
        <option value="complete">Complete</option>
        <option value="error">Error</option>
      </select>
    </div>
    <div id="docTable" class="table-wrap"><div class="loading">Loading documents...</div></div>
    <div id="docPagination" class="pagination"></div>
  </div>

  <!-- PIPELINE TAB -->
  <div id="tab-pipeline" class="tab-content">
    <div class="section-title">Orchestrator Status</div>
    <div id="orchestratorInfo" class="info-block"><div class="loading">Loading...</div></div>
    <div class="section-title">Queue Depths</div>
    <div id="pipelineQueues" class="bar-chart"><div class="loading">Loading...</div></div>
    <div class="section-title">Latest Audit</div>
    <div id="auditInfo" class="info-block"><div class="loading">Loading...</div></div>
    <div class="section-title">Research Plans</div>
    <div id="researchPlans"><div class="loading">Loading...</div></div>
  </div>
</div>

<!-- Slide-out Panel -->
<div id="panelOverlay" class="panel-overlay"></div>
<div id="panel" class="panel">
  <button class="panel-close" id="panelClose">&times;</button>
  <div id="panelContent"></div>
</div>

<script>
(function(){
  const API = window.location.origin;
  let refreshTimer = null;
  let dtcState = { offset: 0, limit: 100, search: '', category: '', data: [] };
  let docState = { offset: 0, limit: 50, stage: '' };
  let categoriesLoaded = false;

  // --- Helpers ---
  async function api(path) {
    try {
      const r = await fetch(API + path);
      if (!r.ok) throw new Error(r.status + ' ' + r.statusText);
      return await r.json();
    } catch(e) {
      console.error('API error:', path, e);
      return null;
    }
  }

  function esc(s) {
    if (s == null) return '';
    const d = document.createElement('div');
    d.textContent = String(s);
    return d.innerHTML;
  }

  function stageBadge(stage) {
    const s = String(stage || '').toLowerCase();
    let cls = 'badge-accent';
    if (s === 'complete' || s === 'completed') cls = 'badge-green';
    else if (s === 'evaluating' || s === 'processing') cls = 'badge-yellow';
    else if (s === 'error' || s === 'failed') cls = 'badge-red';
    else if (s === 'extracting') cls = 'badge-blue';
    return '<span class="badge ' + cls + '">' + esc(stage) + '</span>';
  }

  function severityBadge(sev) {
    const s = String(sev || '').toLowerCase();
    let cls = 'badge-accent';
    if (s === 'critical' || s === 'high') cls = 'badge-red';
    else if (s === 'medium' || s === 'moderate') cls = 'badge-yellow';
    else if (s === 'low') cls = 'badge-green';
    return '<span class="badge ' + cls + '">' + esc(sev) + '</span>';
  }

  function fmtDate(d) {
    if (!d) return '-';
    try { return new Date(d).toLocaleString(); } catch(e) { return String(d); }
  }

  function fmtNum(n) {
    if (n == null) return '-';
    return Number(n).toLocaleString();
  }

  // --- Tab Navigation ---
  document.querySelectorAll('.tab-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.tab-btn').forEach(function(b){ b.classList.remove('active'); });
      document.querySelectorAll('.tab-content').forEach(function(t){ t.classList.remove('active'); });
      btn.classList.add('active');
      document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
      if (btn.dataset.tab === 'overview') loadOverview();
      if (btn.dataset.tab === 'dtc') loadDTC();
      if (btn.dataset.tab === 'documents') loadDocuments();
      if (btn.dataset.tab === 'pipeline') loadPipeline();
    });
  });

  // --- Panel ---
  function openPanel(html) {
    document.getElementById('panelContent').innerHTML = html;
    document.getElementById('panelOverlay').classList.add('open');
    document.getElementById('panel').classList.add('open');
  }
  function closePanel() {
    document.getElementById('panelOverlay').classList.remove('open');
    document.getElementById('panel').classList.remove('open');
  }
  document.getElementById('panelClose').addEventListener('click', closePanel);
  document.getElementById('panelOverlay').addEventListener('click', closePanel);

  // --- Health ---
  async function checkHealth() {
    const dot = document.getElementById('healthDot');
    const data = await api('/health');
    if (data && (data.status === 'ok' || data.status === 'healthy')) {
      dot.className = 'health-dot ok';
      dot.title = 'Healthy';
    } else if (data) {
      dot.className = 'health-dot err';
      dot.title = 'Status: ' + (data.status || 'unknown');
    } else {
      dot.className = 'health-dot err';
      dot.title = 'API unreachable';
    }
  }

  // ==================== OVERVIEW ====================
  async function loadOverview() {
    checkHealth();
    const data = await api('/stats');
    const now = new Date().toLocaleTimeString();
    document.getElementById('overviewRefresh').textContent = 'Updated ' + now;

    if (!data) {
      document.getElementById('statsCards').innerHTML = '<div class="error-msg">Failed to load stats</div>';
      return;
    }

    // Main stat cards
    var cards = '';
    cards += cardHtml('Total Documents', fmtNum(data.total_documents || data.total_docs || data.documents), '', 'accent');
    cards += cardHtml('Processed', fmtNum(data.processed || data.completed || 0), '', 'green');
    cards += cardHtml('In Queue', fmtNum(data.in_queue || data.queued || 0), '', 'yellow');
    cards += cardHtml('Errors', fmtNum(data.errors || data.error_count || 0), '', (data.errors || data.error_count) ? 'red' : 'green');
    document.getElementById('statsCards').innerHTML = cards;

    // By stage
    var stages = data.by_stage || data.stages || data.documents_by_stage || {};
    var stageHtml = '';
    if (typeof stages === 'object' && Object.keys(stages).length > 0) {
      for (var k in stages) {
        stageHtml += '<div class="stage-card"><div class="stage-name">' + esc(k) + '</div><div class="stage-count">' + fmtNum(stages[k]) + '</div></div>';
      }
    } else {
      stageHtml = '<div class="empty-state">No stage data available</div>';
    }
    document.getElementById('stageGrid').innerHTML = stageHtml;

    // Knowledge counts
    var kCards = '';
    kCards += cardHtml('DTC Codes', fmtNum(data.dtc_count || data.dtc_codes || data.dtcs || 0), '', 'blue');
    kCards += cardHtml('Causes', fmtNum(data.cause_count || data.causes || 0), '', 'yellow');
    kCards += cardHtml('Diagnostic Steps', fmtNum(data.step_count || data.steps || data.diagnostic_steps || 0), '', 'green');
    document.getElementById('knowledgeCards').innerHTML = kCards;

    // Queue depths
    var queues = data.queue_depths || data.queues || {};
    renderQueueBars('overviewQueues', queues);
  }

  function cardHtml(label, value, sub, color) {
    return '<div class="card ' + (color||'') + '"><div class="card-label">' + esc(label) + '</div><div class="card-value">' + esc(value) + '</div>' + (sub ? '<div class="card-sub">' + esc(sub) + '</div>' : '') + '</div>';
  }

  function renderQueueBars(elId, queues) {
    var el = document.getElementById(elId);
    if (!queues || Object.keys(queues).length === 0) {
      el.innerHTML = '<div class="empty-state">No queue data</div>';
      return;
    }
    var max = 1;
    for (var k in queues) { if (queues[k] > max) max = queues[k]; }
    var html = '';
    var colors = ['green','blue','yellow','accent'];
    var i = 0;
    for (var k in queues) {
      var pct = Math.max(2, (queues[k] / max) * 100);
      var c = colors[i % colors.length];
      html += '<div class="bar-row"><div class="bar-label">' + esc(k) + '</div><div class="bar-track"><div class="bar-fill ' + c + '" style="width:' + pct + '%">' + fmtNum(queues[k]) + '</div></div></div>';
      i++;
    }
    el.innerHTML = html;
  }

  // ==================== DTC CODES ====================
  async function loadDTC() {
    var search = dtcState.search;
    var cat = dtcState.category;
    var params = '?limit=' + dtcState.limit + '&offset=' + dtcState.offset;
    if (cat) params += '&category=' + encodeURIComponent(cat);
    if (search) params += '&code=' + encodeURIComponent(search);

    var data = await api('/dtc' + params);
    if (!data) {
      document.getElementById('dtcTable').innerHTML = '<div class="error-msg">Failed to load DTC codes</div>';
      return;
    }

    var items = Array.isArray(data) ? data : (data.items || data.results || data.dtcs || data.data || []);
    var total = data.total || data.count || items.length;

    // Populate category filter
    if (!categoriesLoaded && items.length > 0) {
      var cats = {};
      items.forEach(function(d){ if(d.category) cats[d.category] = true; });
      var sel = document.getElementById('dtcCategoryFilter');
      Object.keys(cats).sort().forEach(function(c){
        var o = document.createElement('option');
        o.value = c; o.textContent = c;
        sel.appendChild(o);
      });
      categoriesLoaded = true;
    }

    if (items.length === 0) {
      document.getElementById('dtcTable').innerHTML = '<div class="empty-state">No DTC codes found</div>';
      document.getElementById('dtcPagination').innerHTML = '';
      return;
    }

    var html = '<table><thead><tr><th>Code</th><th>Description</th><th>Category</th><th>Severity</th><th>Confidence</th><th>Sources</th></tr></thead><tbody>';
    items.forEach(function(d){
      html += '<tr data-code="' + esc(d.code) + '">';
      html += '<td class="code-cell">' + esc(d.code) + '</td>';
      html += '<td>' + esc(d.description) + '</td>';
      html += '<td>' + esc(d.category || '-') + '</td>';
      html += '<td>' + severityBadge(d.severity) + '</td>';
      html += '<td>' + (d.confidence != null ? esc((d.confidence * 100).toFixed(0) + '%') : '-') + '</td>';
      html += '<td>' + fmtNum(d.sources || d.source_count || 0) + '</td>';
      html += '</tr>';
    });
    html += '</tbody></table>';
    document.getElementById('dtcTable').innerHTML = html;

    // Click handler
    document.querySelectorAll('#dtcTable tbody tr').forEach(function(row){
      row.addEventListener('click', function(){ loadDTCDetail(row.dataset.code); });
    });

    // Pagination
    var page = Math.floor(dtcState.offset / dtcState.limit) + 1;
    var pages = Math.ceil(total / dtcState.limit);
    var pHtml = '<button id="dtcPrev" ' + (page <= 1 ? 'disabled' : '') + '>Prev</button>';
    pHtml += '<span>Page ' + page + ' of ' + Math.max(pages,1) + '</span>';
    pHtml += '<button id="dtcNext" ' + (page >= pages ? 'disabled' : '') + '>Next</button>';
    document.getElementById('dtcPagination').innerHTML = pHtml;

    document.getElementById('dtcPrev').addEventListener('click', function(){
      dtcState.offset = Math.max(0, dtcState.offset - dtcState.limit);
      loadDTC();
    });
    document.getElementById('dtcNext').addEventListener('click', function(){
      dtcState.offset += dtcState.limit;
      loadDTC();
    });
  }

  async function loadDTCDetail(code) {
    var data = await api('/dtc/' + encodeURIComponent(code));
    if (!data) { openPanel('<div class="error-msg">Failed to load DTC detail</div>'); return; }

    var html = '<div class="panel-code">' + esc(data.code) + '</div>';
    html += '<div class="panel-desc">' + esc(data.description) + '</div>';

    html += '<ul class="detail-list">';
    if (data.category) html += '<li><span class="detail-label">Category</span><span class="detail-value">' + esc(data.category) + '</span></li>';
    if (data.severity) html += '<li><span class="detail-label">Severity</span><span class="detail-value">' + severityBadge(data.severity) + '</span></li>';
    if (data.confidence != null) html += '<li><span class="detail-label">Confidence</span><span class="detail-value">' + esc((data.confidence * 100).toFixed(0) + '%') + '</span></li>';
    html += '</ul>';

    // Causes
    var causes = data.causes || data.possible_causes || [];
    if (causes.length) {
      html += '<h3>Causes</h3>';
      causes.forEach(function(c){
        var name = typeof c === 'string' ? c : (c.name || c.cause || c.description || '');
        var likelihood = typeof c === 'object' ? (c.likelihood || c.probability || '') : '';
        html += '<div class="cause-item"><div class="cause-name">' + esc(name) + '</div>';
        if (likelihood) html += '<div class="cause-likelihood">Likelihood: ' + esc(likelihood) + '</div>';
        html += '</div>';
      });
    }

    // Diagnostic steps
    var steps = data.diagnostic_steps || data.steps || [];
    if (steps.length) {
      html += '<h3>Diagnostic Steps</h3>';
      steps.forEach(function(s, i){
        var desc = typeof s === 'string' ? s : (s.description || s.step || s.action || '');
        html += '<div class="step-item"><span class="step-num">' + (i+1) + '.</span><span class="step-desc">' + esc(desc) + '</span></div>';
      });
    }

    // Related sensors
    var sensors = data.related_sensors || data.sensors || [];
    if (sensors.length) {
      html += '<h3>Related Sensors</h3><div>';
      sensors.forEach(function(s){
        var name = typeof s === 'string' ? s : (s.name || s.sensor || '');
        html += '<span class="sensor-tag">' + esc(name) + '</span>';
      });
      html += '</div>';
    }

    // TSB references
    var tsbs = data.tsb_references || data.tsbs || [];
    if (tsbs.length) {
      html += '<h3>TSB References</h3><div>';
      tsbs.forEach(function(t){
        var ref = typeof t === 'string' ? t : (t.id || t.number || t.reference || '');
        html += '<div class="tsb-ref">' + esc(ref) + '</div>';
      });
      html += '</div>';
    }

    openPanel(html);
  }

  // DTC search/filter handlers
  document.getElementById('dtcSearch').addEventListener('input', debounce(function(e){
    dtcState.search = e.target.value.trim();
    dtcState.offset = 0;
    loadDTC();
  }, 300));
  document.getElementById('dtcCategoryFilter').addEventListener('change', function(e){
    dtcState.category = e.target.value;
    dtcState.offset = 0;
    loadDTC();
  });

  // ==================== DOCUMENTS ====================
  async function loadDocuments() {
    var params = '?limit=' + docState.limit + '&offset=' + docState.offset;
    if (docState.stage) params += '&stage=' + encodeURIComponent(docState.stage);

    var data = await api('/documents' + params);
    if (!data) {
      document.getElementById('docTable').innerHTML = '<div class="error-msg">Failed to load documents</div>';
      return;
    }

    var items = Array.isArray(data) ? data : (data.items || data.results || data.documents || data.data || []);
    var total = data.total || data.count || items.length;

    if (items.length === 0) {
      document.getElementById('docTable').innerHTML = '<div class="empty-state">No documents found</div>';
      document.getElementById('docPagination').innerHTML = '';
      return;
    }

    var html = '<table><thead><tr><th>Title</th><th>Source URL</th><th>Stage</th><th>Chunks</th><th>Ingested</th></tr></thead><tbody>';
    items.forEach(function(d){
      var id = d.id || d.doc_id || d.document_id || '';
      html += '<tr data-id="' + esc(id) + '">';
      html += '<td>' + esc(d.title || d.name || '-') + '</td>';
      html += '<td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + (d.source_url || d.url ? '<a href="' + esc(d.source_url || d.url) + '" target="_blank" title="' + esc(d.source_url || d.url) + '">' + esc(d.source_url || d.url) + '</a>' : '-') + '</td>';
      html += '<td>' + stageBadge(d.stage || d.status) + '</td>';
      html += '<td style="font-family:var(--mono)">' + fmtNum(d.chunks || d.chunk_count || 0) + '</td>';
      html += '<td>' + fmtDate(d.ingested_at || d.created_at || d.ingested) + '</td>';
      html += '</tr>';
    });
    html += '</tbody></table>';
    document.getElementById('docTable').innerHTML = html;

    document.querySelectorAll('#docTable tbody tr').forEach(function(row){
      row.addEventListener('click', function(){ loadDocDetail(row.dataset.id); });
    });

    // Pagination
    var page = Math.floor(docState.offset / docState.limit) + 1;
    var pages = Math.ceil(total / docState.limit);
    var pHtml = '<button id="docPrev" ' + (page <= 1 ? 'disabled' : '') + '>Prev</button>';
    pHtml += '<span>Page ' + page + ' of ' + Math.max(pages,1) + '</span>';
    pHtml += '<button id="docNext" ' + (page >= pages ? 'disabled' : '') + '>Next</button>';
    document.getElementById('docPagination').innerHTML = pHtml;

    document.getElementById('docPrev').addEventListener('click', function(){
      docState.offset = Math.max(0, docState.offset - docState.limit);
      loadDocuments();
    });
    document.getElementById('docNext').addEventListener('click', function(){
      docState.offset += docState.limit;
      loadDocuments();
    });
  }

  async function loadDocDetail(docId) {
    if (!docId) return;
    var data = await api('/documents/' + encodeURIComponent(docId));
    var status = await api('/documents/' + encodeURIComponent(docId) + '/status');

    if (!data) { openPanel('<div class="error-msg">Failed to load document detail</div>'); return; }

    var html = '<h2>' + esc(data.title || data.name || 'Document') + '</h2>';
    html += '<div class="panel-desc">' + (data.source_url || data.url ? '<a href="' + esc(data.source_url || data.url) + '" target="_blank">' + esc(data.source_url || data.url) + '</a>' : 'No source URL') + '</div>';

    html += '<ul class="detail-list">';
    html += '<li><span class="detail-label">ID</span><span class="detail-value" style="font-family:var(--mono)">' + esc(data.id || data.doc_id) + '</span></li>';
    html += '<li><span class="detail-label">Stage</span><span class="detail-value">' + stageBadge(data.stage || data.status) + '</span></li>';
    html += '<li><span class="detail-label">Chunks</span><span class="detail-value">' + fmtNum(data.chunks || data.chunk_count || 0) + '</span></li>';
    html += '<li><span class="detail-label">Ingested</span><span class="detail-value">' + fmtDate(data.ingested_at || data.created_at) + '</span></li>';
    html += '</ul>';

    // Processing timeline from status
    if (status) {
      var log = status.processing_log || status.log || status.stages || status.history || [];
      if (Array.isArray(log) && log.length) {
        html += '<h3>Processing Timeline</h3><div class="timeline">';
        log.forEach(function(entry){
          var stage = entry.stage || entry.name || entry.status || '';
          var time = entry.timestamp || entry.time || entry.completed_at || '';
          var st = entry.status || entry.result || 'done';
          var cls = 'done';
          if (st === 'error' || st === 'failed') cls = 'error';
          else if (st === 'processing' || st === 'active' || st === 'in_progress') cls = 'active';
          html += '<div class="timeline-item ' + cls + '"><span class="tl-stage">' + esc(stage) + '</span><span class="tl-time">' + fmtDate(time) + '</span></div>';
        });
        html += '</div>';
      } else if (status.current_stage || status.stage) {
        html += '<h3>Current Status</h3>';
        html += '<div class="info-block"><div class="info-row"><span class="info-key">Stage</span><span class="info-val">' + esc(status.current_stage || status.stage) + '</span></div></div>';
      }
    }

    openPanel(html);
  }

  document.getElementById('docStageFilter').addEventListener('change', function(e){
    docState.stage = e.target.value;
    docState.offset = 0;
    loadDocuments();
  });

  // ==================== PIPELINE ====================
  async function loadPipeline() {
    // Orchestrator status
    var orch = await api('/orchestrator/status');
    if (orch) {
      var oHtml = '<h4>Orchestrator</h4>';
      if (typeof orch === 'object') {
        for (var k in orch) {
          if (typeof orch[k] !== 'object') {
            oHtml += '<div class="info-row"><span class="info-key">' + esc(k) + '</span><span class="info-val">' + esc(orch[k]) + '</span></div>';
          }
        }
        // Queue depths from orchestrator
        var queues = orch.queue_depths || orch.queues || null;
        if (queues) renderQueueBars('pipelineQueues', queues);
        else document.getElementById('pipelineQueues').innerHTML = '<div class="empty-state">No queue data in orchestrator response</div>';
      }
      document.getElementById('orchestratorInfo').innerHTML = oHtml;
    } else {
      document.getElementById('orchestratorInfo').innerHTML = '<div class="error-msg">Failed to load orchestrator status</div>';
      document.getElementById('pipelineQueues').innerHTML = '';
    }

    // If no queues from orchestrator, try stats
    if (!orch || (!orch.queue_depths && !orch.queues)) {
      var stats = await api('/stats');
      if (stats && (stats.queue_depths || stats.queues)) {
        renderQueueBars('pipelineQueues', stats.queue_depths || stats.queues);
      }
    }

    // Latest audit
    var audit = await api('/audit/latest');
    if (audit) {
      var aHtml = '<h4>Latest Audit</h4>';
      if (typeof audit === 'object') {
        for (var k in audit) {
          var v = audit[k];
          if (typeof v === 'object' && v !== null) v = JSON.stringify(v);
          aHtml += '<div class="info-row"><span class="info-key">' + esc(k) + '</span><span class="info-val">' + esc(v) + '</span></div>';
        }
      }
      document.getElementById('auditInfo').innerHTML = aHtml;
    } else {
      document.getElementById('auditInfo').innerHTML = '<div class="error-msg">Failed to load audit data</div>';
    }

    // Research plans
    var plans = await api('/research/plans');
    if (plans) {
      var items = Array.isArray(plans) ? plans : (plans.items || plans.plans || plans.results || plans.data || []);
      if (items.length === 0) {
        document.getElementById('researchPlans').innerHTML = '<div class="empty-state">No research plans</div>';
      } else {
        var pHtml = '';
        items.forEach(function(p){
          pHtml += '<div class="plan-card">';
          pHtml += '<h4>' + esc(p.title || p.name || p.topic || 'Plan') + '</h4>';
          pHtml += '<div class="plan-meta">';
          if (p.status) pHtml += stageBadge(p.status) + ' ';
          if (p.created_at || p.created) pHtml += fmtDate(p.created_at || p.created);
          pHtml += '</div>';
          var queries = p.queries || p.search_queries || p.steps || [];
          if (queries.length) {
            pHtml += '<ul class="plan-queries">';
            queries.forEach(function(q){
              var text = typeof q === 'string' ? q : (q.query || q.description || q.step || '');
              pHtml += '<li>' + esc(text) + '</li>';
            });
            pHtml += '</ul>';
          }
          if (p.description) pHtml += '<div style="margin-top:8px;font-size:.85rem;color:var(--text2)">' + esc(p.description) + '</div>';
          pHtml += '</div>';
        });
        document.getElementById('researchPlans').innerHTML = pHtml;
      }
    } else {
      document.getElementById('researchPlans').innerHTML = '<div class="error-msg">Failed to load research plans</div>';
    }
  }

  // ==================== Utilities ====================
  function debounce(fn, ms) {
    var t;
    return function() {
      var ctx = this, args = arguments;
      clearTimeout(t);
      t = setTimeout(function(){ fn.apply(ctx, args); }, ms);
    };
  }

  // ==================== Init ====================
  function startAutoRefresh() {
    if (refreshTimer) clearInterval(refreshTimer);
    refreshTimer = setInterval(function(){
      var active = document.querySelector('.tab-btn.active');
      if (active && active.dataset.tab === 'overview') loadOverview();
    }, 10000);
  }

  loadOverview();
  startAutoRefresh();
})();
</script>
</body>
</html>
